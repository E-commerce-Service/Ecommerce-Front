<div
   class="w-full mx-auto bg-slate-50 rounded-xl border border-slate-200 py-3 px-3 md:p-4 my-2"
>
   <div class="flex items-start gap-3 md:gap-4">
      <img
         ngSrc="assets/icons/avatar.svg"
         alt="Avatar"
         width="40"
         height="40"
         class="rounded-full w-10 h-10 object-cover shrink-0"
      />

      <div class="flex-1 min-w-0">
         <div class="flex items-start justify-between">
            <div class="flex flex-col gap-1">
               <div class="flex items-center gap-2 flex-wrap">
                  <h3 class="font-semibold text-slate-900 text-sm md:text-base">
                     {{ review.customerName }}
                  </h3>
                  <span class="text-xs text-slate-400">•</span>
                  <p class="text-xs text-slate-500">
                     {{ review.createdAt | date: "dd/MM/yy, HH:mm" }}
                  </p>
               </div>
               <div class="flex items-center gap-1.5">
                  <app-stars
                     [productRating]="review.rating"
                     class="scale-90 origin-left"
                  ></app-stars>
                  <span class="font-semibold text-slate-700 text-xs">{{
                     review.rating.toFixed(1)
                  }}</span>
               </div>
            </div>

            @if (isOwner) {
               <div class="relative">
                  <button
                     (click)="toggleToolbox()"
                     class="p-2 -mr-2 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"
                     aria-label="Opções"
                  >
                     <img
                        ngSrc="assets/icons/dots-vertical.svg"
                        alt="Opções"
                        width="20"
                        height="20"
                     />
                  </button>

                  @if (isToolboxOpen) {
                     <div
                        (click)="$event.stopPropagation()"
                        (keydown)="$event.stopPropagation()"
                        tabindex="0"
                        class="absolute top-full right-0 mt-1 w-40 bg-white border border-slate-200 rounded-lg shadow-xl z-20 overflow-hidden toolbox-animate"
                     >
                        <ul class="py-1">
                           <li>
                              <button
                                 (click)="onEdit()"
                                 class="w-full text-left px-4 py-3 text-sm text-slate-700 hover:bg-slate-50 flex items-center gap-3 active:bg-slate-100"
                              >
                                 <img
                                    ngSrc="assets/icons/edit.svg"
                                    alt="Editar"
                                    width="18"
                                    height="18"
                                 />
                                 <span>Editar</span>
                              </button>
                           </li>
                           <li>
                              <button
                                 (click)="onDelete()"
                                 class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 active:bg-red-100"
                              >
                                 <img
                                    ngSrc="assets/icons/delete.svg"
                                    alt="Deletar"
                                    width="18"
                                    height="18"
                                 />
                                 <span>Deletar</span>
                              </button>
                           </li>
                        </ul>
                     </div>
                  }
               </div>
            }
         </div>

         <p
            class="text-slate-800 text-sm leading-relaxed mt-2 review-text break-words"
            [class.expanded]="isExpanded"
            appOverflowDetector
            (isOverflowing)="onOverflowChange($event)"
         >
            {{ review.content }}
         </p>

         @if (contentIsOverflowing) {
            <button
               (click)="toggleExpand()"
               class="flex items-center gap-1 mt-1 text-xs font-medium text-blue-600 hover:underline focus:outline-none"
            >
               <span>{{ isExpanded ? "Ver menos" : "Ver mais" }}</span>
               <img
                  ngSrc="assets/icons/chevron-down.svg"
                  alt="Expandir"
                  width="14"
                  height="14"
                  class="transition-transform duration-300"
                  [class.rotate-180]="isExpanded"
               />
            </button>
         }
      </div>
   </div>

   <div
      class="flex items-center gap-4 text-slate-600 mt-3 md:ml-14 ml-0 border-t border-slate-200/60 pt-2 md:border-none md:pt-0"
   >
      <button
         (click)="onLike()"
         [class.text-blue-600]="review.likedByMe"
         [class.font-bold]="review.likedByMe"
         class="flex items-center gap-1.5 px-3 py-1 rounded-full hover:bg-slate-200/50 transition-colors active:scale-95"
      >
         <img
            [ngSrc]="
               review.likedByMe
                  ? '/assets/icons/like-full.svg'
                  : '/assets/icons/like.svg'
            "
            alt="Like"
            width="18"
            height="18"
         />
         <span class="text-xs font-medium">{{ review.likes }}</span>
      </button>

      <button
         (click)="onDislike()"
         [class.text-red-600]="review.dislikedByMe"
         [class.font-bold]="review.dislikedByMe"
         class="flex items-center gap-1.5 px-3 py-1 rounded-full hover:bg-slate-200/50 transition-colors active:scale-95"
      >
         <img
            [ngSrc]="
               review.dislikedByMe
                  ? '/assets/icons/dislike-full.svg'
                  : '/assets/icons/dislike.svg'
            "
            alt="Dislike"
            width="18"
            height="18"
         />
         <span class="text-xs font-medium">{{ review.dislikes }}</span>
      </button>

      <button
         (click)="onToggleComments()"
         [disabled]="review.totalComments < 1"
         class="flex items-center gap-1.5 px-3 py-1 rounded-full hover:bg-slate-200/50 transition-colors active:scale-95 disabled:opacity-50"
      >
         <img
            ngSrc="/assets/icons/comment.svg"
            alt="Comentários"
            width="18"
            height="18"
         />
         <span class="text-xs font-medium">{{ review.totalComments }}</span>
      </button>

      <button
         (click)="onReply()"
         class="flex items-center gap-1.5 px-3 py-1 rounded-full hover:bg-slate-200/50 transition-colors active:scale-95 ml-auto md:ml-0"
      >
         <img
            ngSrc="/assets/icons/reply.svg"
            alt="Responder"
            width="18"
            height="18"
         />
         <span class="hidden md:inline text-xs font-medium">Responder</span>
      </button>
   </div>

   @if (isReplying) {
      <div class="mt-3 md:ml-14 animate-fade-in">
         <app-reply-form
            (submitReply)="handleReplySubmission($event)"
            (cancelReply)="handleCancelReply()"
         ></app-reply-form>
      </div>
   }

   <div class="w-full">
      @if (isCommentsExpanded && commentState) {
         <div class="mt-3 md:ml-14 space-y-3 border-t border-slate-200 pt-3">
            @for (comment of commentState.comments; track comment.commentId) {
               <app-comment-card
                  [comment]="comment"
                  (like)="onCommentLike($event)"
                  (dislike)="onCommentDislike($event)"
                  (reply)="onCommentReply($event)"
                  (delete)="onCommentDelete($event)"
               ></app-comment-card>

               @if (replyingToCommentId === comment.commentId) {
                  <div class="pl-4 md:pl-12 pt-2">
                     <app-reply-form
                        [mentionUser]="mentioningUserName"
                        (submitReply)="handleCommentReplySubmission($event)"
                        (cancelReply)="replyingToCommentId = null"
                     ></app-reply-form>
                  </div>
               }
            }

            <div
               class="w-full flex justify-center items-center gap-4 pt-2 pb-1"
            >
               @if (commentState.hasMore && !commentState.loading) {
                  <button
                     (click)="onLoadMoreComments()"
                     class="flex items-center gap-1.5 text-xs font-medium text-blue-600 hover:text-blue-800"
                  >
                     <img
                        ngSrc="assets/icons/plus.svg"
                        alt=""
                        width="14"
                        height="14"
                     />
                     <span>Ver mais</span>
                  </button>
               }

               @if (
                  commentState.comments.length > INITIAL_COMMENT_LIMIT &&
                  !commentState.loading
               ) {
                  <button
                     (click)="onShowLessComments()"
                     class="flex items-center gap-1.5 text-xs font-medium text-gray-500 hover:text-gray-700"
                  >
                     <img
                        ngSrc="assets/icons/minus.svg"
                        alt=""
                        width="14"
                        height="14"
                     />
                     <span>Ver menos</span>
                  </button>
               }
            </div>
         </div>
      } @else if (isCommentsExpanded && !commentState) {
         <div class="mt-3 md:ml-14 text-center">
            <p class="text-xs text-slate-400 italic">
               Carregando comentários...
            </p>
         </div>
      }
   </div>
</div>
